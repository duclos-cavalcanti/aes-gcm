#include "gcm_test.h"

#include "gcm.h"
#include "util.h"

int gcmTest(bool verbose) {
    int result;

    const uint8_t key[16] =
    {
        0xAD, 0x7A, 0x2B, 0xD0,
        0x3E, 0xAC, 0x83, 0x5A,
        0x6F, 0x62, 0x0F, 0xDC,
        0xB5, 0x06, 0xB3, 0x45,
    };

    uint8_t plaintext[60] =
    {
        0x08, 0x00, 0x0F, 0x10,
        0x11, 0x12, 0x13, 0x14,
        0x15, 0x16, 0x17, 0x18,
        0x19, 0x1A, 0x1B, 0x1C,
        0x1D, 0x1E, 0x1F, 0x20,
        0x21, 0x22, 0x23, 0x24,
        0x25, 0x26, 0x27, 0x28,
        0x29, 0x2A, 0x2B, 0x2C,
        0x2D, 0x2E, 0x2F, 0x30,
        0x31, 0x32, 0x33, 0x34,
        0x35, 0x36, 0x37, 0x38,
        0x39, 0x3A, 0x00, 0x02,
    };

    const uint8_t iv[12] =
    {
        0x12, 0x15, 0x35, 0x24,
        0xC0, 0x89, 0x5E, 0x81,
        0xB2, 0xC2, 0x84, 0x65,
    };

    const uint8_t a[28] =
    {
        0xD6, 0x09, 0xB1, 0xF0,
        0x56, 0x63, 0x7A, 0x0D,
        0x46, 0xDF, 0x99, 0x8D,
        0x88, 0xE5, 0x2E, 0x00,
        0xB2, 0xC2, 0x84, 0x65,
        0x12, 0x15, 0x35, 0x24,
        0xC0, 0x89, 0x5E, 0x81,
    };

    const uint8_t correct_encrypted[] =
    {
        0x70, 0x1A, 0xFA, 0x1C,
        0xC0, 0x39, 0xC0, 0xD7,
        0x65, 0x12, 0x8A, 0x66,
        0x5D, 0xAB, 0x69, 0x24,
        0x38, 0x99, 0xBF, 0x73,
        0x18, 0xCC, 0xDC, 0x81,
        0xC9, 0x93, 0x1D, 0xA1,
        0x7F, 0xBE, 0x8E, 0xDD,
        0x7D, 0x17, 0xCB, 0x8B,
        0x4C, 0x26, 0xFC, 0x81,
        0xE3, 0x28, 0x4F, 0x2B,
        0x7F, 0xBA, 0x71, 0x3D,
    };

    const uint8_t correct_tag[] =
    {
        0x4F, 0x8D, 0x55, 0xE7,
        0xD3, 0xF0, 0x6F, 0xD5,
        0xA1, 0x3C, 0x0C, 0x29,
        0xB9, 0xD5, 0xB8, 0x80,
    };

    gcm_context_t gcm = {
        .plaintext = plaintext,
        .plaintext_size = 60,
        .key = key,
        .iv = iv,
        .auth = a,
        .auth_size = 28,
    };

    if (verbose) {
        printf( "\n========= GCM =========\n");
        printArray(plaintext, 60, "Input");
    }

    gcmAesEncrypt(&gcm);

    if (verbose) {
        printArray(gcm.ciphertext, 60, "Encryption");
        printArray(correct_encrypted, 60, "Correct Encryption");
    }

    if (verbose) {
        printArray(gcm.tag, 16, "Tag");
        printArray(correct_tag, 16, "Correct Tag");
    }

    if (!equalArrays(gcm.ciphertext, correct_encrypted, 60)) {
        printf("Encryption doesnt match");
        return 0;
    }

    if (!equalArrays(gcm.tag, correct_tag, 16)) {
        printf("Tag doesnt match");
        return 0;
    }

    // gcm.plaintext = NULL;
    // result = gcmAesDecrypt(&gcm);
    // if (verbose) {
    //     printArray(gcm.plaintext, 60, "Decryption");
    // }

    return 1;
}
